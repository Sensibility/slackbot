#!/usr/bin/python3

from pep3143daemon import DaemonContext as Daemon, PidFile
from slacker import Slacker

from pwd import getpwnam

print("Slackbot daemon starting up... ");

pidfile = PidFile('/var/run/slackbot.pid');
pidfile.acquire();

print("Pid file located at: /var/run/slackbot.pid");

daemon = Daemon(pidfile=pidfile,stdout=open('/var/log/slackbot.log',mode='w'), stderr=open('/var/log/slackbot.log',mode='w'));

daemon.open();

slackbot = Slacker(open('/etc/slackbot/API').read().strip());

users = slackbot.users.list().body['users']

listenChannels = []
lastheard = {}

for channel in slackbot.channels.list().body['channels']:
	if channel['is_member']:
		listenChannels.append(channel)
		lastheard{channel['id']} = None

while(True):
	for channel in listenChannels:
		chat_hist = slackbot.channels.history(channel['id']).body['messages']
		for message in chat_hist:
			if lastheard[message['id']] == message[channel['id']]:
				break
			if 'text' in message:
				print(message['text'])
